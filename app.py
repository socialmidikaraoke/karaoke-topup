import streamlit as st
import gspread
from google.oauth2.service_account import Credentials
from check_slip_s2g import check_slip_slip2go
import os

# --- ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö ---
st.set_page_config(page_title="‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å", page_icon="üé§")

# --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Sheet ---
def get_google_sheet():
    scopes = [
        "https://www.googleapis.com/auth/spreadsheets",
        "https://www.googleapis.com/auth/drive"
    ]
    creds = Credentials.from_service_account_info(
        st.secrets["gcp_service_account"], 
        scopes=scopes
    )
    client = gspread.authorize(creds)
    # ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡πÄ‡∏õ‡πä‡∏∞‡πÜ
    sheet = client.open("Midi Slip System Data").sheet1 
    return sheet

# --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å (‡∏Å‡∏±‡∏ô‡∏™‡∏•‡∏¥‡∏õ‡∏ã‡πâ‡∏≥ + ‡πÄ‡∏ä‡πá‡∏Å‡∏ä‡∏∑‡πà‡∏≠) ---
def update_member_status(user_input, amount_paid, trans_ref):
    try:
        sheet = get_google_sheet()
        
        # --- 1. ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏±‡∏ô‡∏™‡∏•‡∏¥‡∏õ‡∏ã‡πâ‡∏≥ (Anti-Duplicate) ---
        # ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏´‡∏±‡∏™ TransRef ‡πÉ‡∏ô Sheet ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡∏ñ‡πâ‡∏≤‡πÄ‡∏à‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡πÄ‡∏Ñ‡∏¢‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß
        # (‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å TransRef ‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå E (5))
        try:
            # ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ trans_ref ‡πÉ‡∏ô sheet
            found = sheet.find(trans_ref)
            if found:
                return False, f"‚õî ‡∏™‡∏•‡∏¥‡∏õ‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö! (‡∏£‡∏´‡∏±‡∏™: {trans_ref})"
        except:
            pass # ‡∏ñ‡πâ‡∏≤‡∏´‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡∏™‡∏•‡∏¥‡∏õ‡πÉ‡∏´‡∏°‡πà (‡∏ú‡πà‡∏≤‡∏ô)

        # --- 2. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å ---
        all_data = sheet.get_all_values()
        target_row = None
        user_input = user_input.strip()
        
        for i, row in enumerate(all_data):
            if len(row) <= 6: continue # ‡∏Ç‡πâ‡∏≤‡∏°‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö
            
            # ‡πÄ‡∏ä‡πá‡∏Å Col A (MemberID)
            member_id = row[0].strip()
            # ‡πÄ‡∏ä‡πá‡∏Å Col G (‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏´‡∏•‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ ‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏≠‡∏°‡∏°‡∏≤)
            account_names = [name.strip() for name in row[6].split(',')]
            
            if user_input == member_id or user_input in account_names:
                target_row = i + 1
                break
        
        if target_row:
            # --- ‡πÄ‡∏à‡∏≠‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß! ---
            
            # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ß‡∏±‡∏ô
            days_to_add = 0
            if amount_paid >= 100: days_to_add = 30
            elif amount_paid >= 50: days_to_add = 15
            else: days_to_add = 7
            
            # ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            # Col C (3) = ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
            sheet.update_cell(target_row, 3, "Active") 
            # Col D (4) = ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
            sheet.update_cell(target_row, 4, f"‡πÄ‡∏ï‡∏¥‡∏° {amount_paid}‡∏ö. (+{days_to_add}‡∏ß‡∏±‡∏ô) {trans_ref}")
            # Col E (5) = ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å TransRef (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å! ‡πÄ‡∏≠‡∏≤‡πÑ‡∏ß‡πâ‡πÄ‡∏ä‡πá‡∏Å‡∏ã‡πâ‡∏≥‡∏£‡∏≠‡∏ö‡∏´‡∏ô‡πâ‡∏≤)
            sheet.update_cell(target_row, 5, trans_ref)
            
            return True, f"‚úÖ ‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢! ({days_to_add} ‡∏ß‡∏±‡∏ô) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö: {user_input}"
        else:
            return False, f"‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å '{user_input}' ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö"
            
    except Exception as e:
        return False, f"Google Sheet Error: {e}"

# --- ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ (UI) ---
st.title("üé§ ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏Ñ‡∏≤‡∏£‡∏≤‡πÇ‡∏≠‡πÄ‡∏Å‡∏∞")

with st.form("topup_form"):
    user_input = st.text_input("üë§ ‡∏Å‡∏£‡∏≠‡∏Å Member ID ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ (‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏ô Col G)")
    uploaded_file = st.file_uploader("üí∏ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô", type=['jpg', 'png', 'jpeg'])
    submit_button = st.form_submit_button("‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô")

if submit_button:
    if not user_input or not uploaded_file:
        st.warning("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö")
    else:
        with st.spinner("‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏•‡∏¥‡∏õ..."):
            with open("temp_slip.jpg", "wb") as f:
                f.write(uploaded_file.getbuffer())
            
            # ‡∏™‡πà‡∏á‡πÑ‡∏õ‡πÄ‡∏ä‡πá‡∏Å‡∏Å‡∏±‡∏ö Slip2Go
            slip_result = check_slip_slip2go("temp_slip.jpg")
            
            if os.path.exists("temp_slip.jpg"):
                os.remove("temp_slip.jpg")
            
            if slip_result['success']:
                amount = slip_result.get('amount', 0)
                sender = slip_result.get('sender', '-')
                # ‡∏î‡∏∂‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏°‡∏≤‡∏î‡πâ‡∏ß‡∏¢ (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏≤‡πÑ‡∏õ‡πÄ‡∏ä‡πá‡∏Å‡∏ã‡πâ‡∏≥)
                trans_ref = slip_result.get('transRef', '')
                
                if not trans_ref:
                    # ‡∏Å‡∏±‡∏ô‡πÄ‡∏´‡∏ô‡∏µ‡∏¢‡∏ß ‡∏Å‡∏£‡∏ì‡∏µ Slip2Go ‡πÑ‡∏°‡πà‡∏™‡πà‡∏á ref ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤
                    st.error("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏™‡∏•‡∏¥‡∏õ (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ)")
                else:
                    st.info(f"‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡πà‡∏≤‡∏ô: ‡∏¢‡∏≠‡∏î {amount} ‡∏ö‡∏≤‡∏ó (Ref: {trans_ref})")
                    
                    # ‡∏ß‡∏¥‡πà‡∏á‡πÑ‡∏õ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Sheet (‡∏™‡πà‡∏á trans_ref ‡πÑ‡∏õ‡πÄ‡∏ä‡πá‡∏Å‡∏ã‡πâ‡∏≥‡∏î‡πâ‡∏ß‡∏¢)
                    with st.spinner("‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡∏ã‡πâ‡∏≥..."):
                        success, msg = update_member_status(user_input, amount, trans_ref)
                        
                        if success:
                            st.success(msg)
                            st.balloons()
                        else:
                            st.error(msg)
            else:
                st.error(f"‚ùå ‡∏™‡∏•‡∏¥‡∏õ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: {slip_result['message']}")
